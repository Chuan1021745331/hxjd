<#include "../../_include/_layout.inc.tag"/> <@layout
active_id="dashboard">
<link rel="stylesheet" type="text/css" media="all" href="${CPATH}/css/smart/msmart.css">
<link rel="stylesheet" type="text/css" media="all" href="${CPATH}/css/smart/smart.css">
<form class="layui-form" action="" style="margin: 10px 10px 0px 10px;">
    <input type="hidden" name="jTbm.worksiteid" value="<#if worksite??>${worksite.id}</#if>">
    <input type="hidden" name="jTbm.id" value="<#if tbm??>${tbm.id}</#if>">
    <div class="layui-form-item">
        <label class="layui-form-label">所属节点</label>
            <div class="layui-input-inline" style="width: 100px;">
                <input type="text" class="layui-input" value="根节点" readonly = "readonly" style="color: #009688;font-weight: bolder;">

            </div>

            <div class="layui-form-mid">——></div>
            <div class="layui-input-inline" style="width: 100px;">
                <input type="text" class="layui-input" value="${circuit.name}" readonly = "readonly" style="color: #009688;font-weight: bolder;">

            </div>

            <div class="layui-form-mid">——></div>
            <div class="layui-input-inline" style="width: 100px;">
                <input type="text" class="layui-input" value="${worksite.name}" readonly = "readonly" style="color: #009688;font-weight: bolder;">

            </div>


    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">名称</label>
        <div class="layui-input-inline">
            <input type="text" class="layui-input" readonly value="<#if tbm??>${tbm.name!}</#if>">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">盾构机编码</label>
        <div class="layui-input-inline">
            <input type="text" readonly value="<#if tbm??>${tbm.code!}</#if>"  class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">客户端Mac地址</label>
        <div class="layui-input-inline">
            <input type="text" readonly value="<#if tbm??>${tbm.mac!}</#if>"  class="layui-input">
        </div>
    </div>
</form>
<!--添加摄像头-->
<div class="layui-row ms-margin-left-2rem ">
    <!--<div class="layui-col-md1 debug"> </div>-->
    <button id="addCamera" class="layui-btn ms-margin-left-2rem ">
        <i class="layui-icon">&#xe608;</i> 添加摄像头
    </button>
</div>
<hr class="layui-bg-gray">
<!--展示摄像头-->
<div id="showCamera" class="sm-width-80-per ms-padding-left-2rem sm-layout-center-vertical ">
<#if cameras??>
    <#list cameras as camera>
        <div id="camera${camera.id!}" class="sm-width-100-per sm-height-20-per ms-margin-top-1rem ms-layout-center-horizontal " style="background-color: #f2f2f2;">
             <div id="cameraName${camera.id!}" class="ms-width-20-per sm-height-100-per    "  style="background-color: #f2f2f2;">${camera.name!}</div>
             <div id="cameraRtsp${camera.id!}" class="ms-width-60-per sm-height-100-per    "  style="background-color: #f2f2f2;">${camera.rtsp!}</div>
             <div class="ms-width-5-per  sm-height-100-per ms-margin-left-1rem  ms-layout-center-horizontal "  style="background-color: #ffffff;" >
                 <button data="${camera.id!}"  class="editCamera layui-btn layui-btn-sm layui-btn-primary">
                     <i class="layui-icon">&#xe642;</i>
                 </button>
             </div>
            <div class="ms-width-18-per  sm-height-100-per  "  style="background-color: #ffffff;">
                <button data="${camera.id!}"  class="delCamera layui-btn layui-btn-sm layui-btn-primary">
                    <i class="layui-icon">&#xe640;</i>
                </button>
            </div>
        </div>
    </#list>
</#if>
</div>
<!--添加摄像头模态框-->
<div id="addCameraDiv" hidden>
    <form class="layui-form " action="" style="margin: 10px 10px 0px 10px;">
        <input type="hidden" name="jCamera.tbmid" value="<#if tbm??>${tbm.id}</#if>">
        <div class="layui-form-item">
            <label class="layui-form-label">摄像头名称</label>
            <div class="layui-input-block">
                <input type="text" id="addCname" name="jCamera.name" required lay-verify="required"
                       placeholder="请输入摄像头名称" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">rtsp</label>
            <div class="layui-input-block">
                <input type="text" id="addCrtsp" name="jCamera.rtsp" required lay-verify="required"
                       placeholder="请输入rtsp" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="formAddAndUpdateCamera">立即提交</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</div>

<!--修改摄像头模态框-->
<div id="editCameraDiv" hidden>
    <form class="layui-form " action="" style="margin: 10px 10px 0px 10px;">
        <input type="hidden" name="jCamera.tbmid" value="<#if tbm??>${tbm.id}</#if>">
        <input id="cameraId" type="hidden" name="jCamera.id">
        <div class="layui-form-item">
            <label class="layui-form-label">摄像头名称</label>
            <div class="layui-input-block">
                <input id="cameraName" type="text" name="jCamera.name" required lay-verify="required"
                       placeholder="请输入摄像头名称" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">rtsp</label>
            <div class="layui-input-block">
                <input  id="cameraRtsp" type="text" name="jCamera.rtsp" required lay-verify="required"
                       placeholder="请输入rtsp" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="formAddAndUpdateCamera">立即提交</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</div>


<script>
    layui.use(["layer","form","element","common"],function () {
        var layer = layui.layer
        var form = layui.form
        var element = layui.element
        var common = layui.common
        var index;
        var cameraID="NULL";
        var addIndex;
        /*打开添加摄像头模态框*/
        $("#addCamera").click(function () {
            addIndex = layer.open({
                type: 1,
                area: ['550px', '260px'],
                content: $('#addCameraDiv') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
            });
        })
        editCamera();
        //修改摄像头信息模态框
        function editCamera() {
            $(".editCamera").click(function () {
                var cameraId = $(this).attr('data');
                console.log("#cameraName"+cameraId)
                var cameraName = $("#cameraName"+cameraId).html()
                var cameraRtsp = $("#cameraRtsp"+cameraId).html()
                $("#cameraId").val(cameraId);
                console.log("#cameraId.val();="+$("#cameraId").val())
                $("#cameraName").val(cameraName);
                $("#cameraRtsp").val(cameraRtsp);
                index = layer.open({
                    type: 1,
                    area: ['550px', '260px'],
                    content: $('#editCameraDiv'), //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
                    cancel: function(){
                        //右上角关闭回调
                        $("#cameraId").val('');
                        //return false 开启该代码可禁止点击该按钮关闭
                    }
                });
            })
        }

        /*删除摄像头*/
        formSubmitDelCamera(bpath+'/admin/route/delCamera');
        function formSubmitDelCamera(url) {
            $(".delCamera").click(function () {
                var cameraId = $(this).attr('data');
                $.ajax({
                    url:url,
                    type:"POST",
                    data:{cid:cameraId},
                    dataType:"json",
                    success:function(json){
                        if(json.errorCode==0){
                            top.parent.MSG(4,  json.message);
                            $("#showCamera").children().remove("#camera"+cameraId);
                        }else{
                            top.parent.MSG(3,  json.message);
                        }
                    },
                    error:function(res){
                        top.parent.MSG(3, "数据提交异常");
                    }
                });
                return false;
            });
        }

        /*提交修改或者添加摄像头信息*/
        formSubmitCamera('formAddAndUpdateCamera',bpath+'/admin/route/addAndUpdateCamera');
        function formSubmitCamera(id,url){
            form.on('submit('+id+')', function(data) {

                var de = $("#cameraId").val();
                if(de != ''){
                    /*修改摄像头*/
                    cameraID = $("#cameraId").val();
                    $("#cameraId").val('');
                }
                $.ajax({
                    url:url,
                    type:"POST",
                    data:data.field,
                    dataType:"json",
                    success:function(json){
                        if(json.errorCode==0){
                            top.parent.MSG(4,  json.message);
                            var data = json.data;
                            var cid = data.id;
                            var name = data.name;
                            var rtsp = data.rtsp;
                            /*添加摄像头*/
                            if(cameraID == 'NULL'){
                                var html = '<div id="camera'+cid+'" class="sm-width-100-per sm-height-20-per ms-margin-top-1rem ms-layout-center-horizontal " style="background-color: #f2f2f2;">'
                                                +'<div id="cameraName'+cid+'" class="ms-width-20-per sm-height-100-per   "  style="background-color: #f2f2f2;">'+name+'</div>'
                                                 +'<div id="cameraRtsp'+cid+'" class="ms-width-60-per sm-height-100-per    "  style="background-color: #f2f2f2;">'+rtsp+'</div>'
                                                 +'<div class="ms-width-5-per  sm-height-100-per ms-margin-left-1rem  ms-layout-center-horizontal "  style="background-color: #ffffff;">'
                                                         +'<button data="'+cid+'" class="editCamera layui-btn layui-btn-sm layui-btn-primary">'
                                                            +'<i class="layui-icon">&#xe642;</i>'
                                                         +'</button>'
                                                 +'</div>'
                                                 +'<div class="ms-width-18-per  sm-height-100-per  "  style="background-color: #ffffff;">'
                                                        +'<button data="'+cid+'"  class="delCamera layui-btn layui-btn-sm layui-btn-primary">'
                                                            +'<i class="layui-icon">&#xe640;</i>'
                                                        +'</button>'
                                                 +'</div>'
                                            + '</div>';

                                $("#showCamera").append(html)

                                /*解除修改摄像头信息的模态框弹出事件*/
                                $(".editCamera").unbind();
                                /*从新绑定弹出事件*/
                                editCamera();
                                /*解除删除事件*/
                                $(".delCamera").unbind();
                                /*绑定删除事件*/
                                formSubmitDelCamera(bpath+'/admin/route/delCamera');
                                /*关闭添加模态框*/
                                layer.close(addIndex)
                                cameraID = "NULL";

                                $("#addCname").val('')
                                $("#addCrtsp").val('')
                                return;
                            }
                            /*修改摄像头*/
                            $("#cameraName"+cameraID).empty();
                            $("#cameraName"+cameraID).html(name)
                            $("#cameraRtsp"+cameraID).html(rtsp)
                            cameraID = "NULL";
                            layer.close(index)
                        }else{
                            top.parent.MSG(3,  json.message);
                        }

                    },
                    error:function(res){
                        top.parent.MSG(3, "数据提交异常");
                    }
                });

                return false;
            });
        }


    });

</script>
</@layout>
