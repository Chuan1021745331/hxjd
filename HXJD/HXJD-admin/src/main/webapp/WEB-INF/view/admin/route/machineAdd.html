<#include "../../_include/_layout.inc.tag"/> <@layout
active_id="dashboard">
<link rel="stylesheet" type="text/css" media="all" href="${CPATH}/css/smart/msmart.css">
<link rel="stylesheet" type="text/css" media="all" href="${CPATH}/css/smart/smart.css">
<link rel="stylesheet" href="${CPATH}/css/main1119.css"/>
<link rel="stylesheet" href="${CPATH}/css/cxColor/jquery.cxcolor.css"/>
<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.3&key=6bcb8a1e8feb4b3da331adac45ae2dea">

</script>
<div class="layui-row ">
    <div class="layui-col-md3">
        <form class="layui-form ms-layout-nowrap-vertical" action="" style="margin: 10px 10px 0px 10px;">
            <input type="hidden" name="jTbm.worksiteid" value="<#if worksite??>${worksite.id}</#if>">
            <div class="sm-width-100-per  sm-layout-center-horizontal ms-margin-top-1rem">
                <label class="layui-form-label">所属工点</label>
                <div class="sm-width-80-per">
                    <input type="text" required lay-verify="required"
                           placeholder="点击右边选择所属菜单" autocomplete="off" class="layui-input"
                           value="<#if worksite??>${worksite.name}</#if>"
                           id="routeSel" disabled="disabled" style="color: #009688;font-weight: bolder;">
                </div>
            </div>
            <div class="sm-width-100-per  sm-layout-center-horizontal ms-margin-top-1rem">
                <label class="layui-form-label">名称</label>
                <div class="sm-width-80-per">
                    <input type="text" name="jTbm.name" required lay-verify="required"
                           placeholder="请输入盾构机名称" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div  style="display: none" class="sm-width-100-per  sm-layout-center-horizontal ms-margin-top-1rem">
                <label class="layui-form-label">坐标</label>
                <div class="sm-width-80-per">
                    <input id="addTbmCoord" type="text" name="jTbm.coord" readonly lay-verify="required"
                           placeholder="请选择盾构机坐标" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="sm-width-100-per  sm-layout-center-horizontal ms-margin-top-1rem">
                <label class="layui-form-label">盾构机编码</label>
                <div class="sm-width-80-per">
                    <input type="text" name="jTbm.code" required lay-verify="required"
                           placeholder="请输入盾构机编码" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="sm-width-100-per  sm-layout-center-horizontal ms-margin-top-1rem">
                <label class="layui-form-label">Mac地址</label>
                <div class="sm-width-80-per">
                    <input type="text" name="jTbm.mac" required lay-verify="required"
                           placeholder="请输入推流计算机Mac地址" autocomplete="off" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item ms-margin-top-1rem">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="formDemo">立即提交</button>
                    <button type="reset" class="restPoints layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>

    <!--隐藏的线路坐标数据-->
    <input id="hiddenPoints" type="hidden" value="<#if circuit??>${circuit.points}</#if>"/>
    <input id="hiddenCircuitColor" type="hidden" value="<#if circuit??>${circuit.color}</#if>"/>
    <!--隐藏的工点坐标数据-->
    <input id="hiddenCoord" type="hidden" value="<#if worksite??>${worksite.coord}</#if>"/>
    <input id="hiddenWorksiteColor" type="hidden" value="<#if worksite??>${worksite.color}</#if>"/>

    <!--map-->
    <div class="layui-col-md9  ms-left-border-2px-black ms-height-100-per" style="height: 800px;">
        <div id="container" class="ms-height-100-per ms-width-100-per ">

        </div>
    </div>

</div>
<div id="departmentContent" class="departmentContent" style="display:none; position: absolute;">
    <ul id="treeDemo" class="ztree" style="margin-top:0; width:160px;"></ul>
</div>
<script charset="utf-8" src="${CPATH}/plus/kindeditor/kindeditor-all-min.js"></script>
<script charset="utf-8" src="${CPATH}/plus/kindeditor/lang/zh-CN.js"></script>
<script charset="utf-8" src="${CPATH}/js/jquery.cxcolor.min.js"></script>
<script>
    layui.use(['form', 'common'], function () {
        var form = layui.form,
            common = layui.common;
        common.formSubmit('formDemo', bpath + '/admin/route/saveAndUpdateTbm');

        /*创建高德地图*/
        var map = new AMap.Map('container', {
            layers: [new AMap.TileLayer.Satellite({zIndex:10})],
            zoom: 13,
            center: [106.545474,29.601621]
        });

        /*全局变量*/
        var marker = "NULL";

        map.on('click',function (e) {
            if(marker != "NULL"){
                clearTag();
            }
            var x = e.lnglat.getLng();
            var y = e.lnglat.getLat();
            creatMaker(x,y);
        });

        /*初始化*/
        function init() {
            initLine();
            initWorkSite();
        }

        init();

        /*解析坐标为数组*/
        function analysisPoints(points) {
            var lineStr = new Array();
            lineStr = points.split("#");

            var items = new Array();
            for(var j = 0;j<lineStr.length;j++){

                var str = lineStr[j].split(",");
                var x = str[0];
                var y = str[1];
                items[j]= [x,y];
            }
            return items;
        }
        /*将盾构机坐标保存到表单*/
        function setAddPoints(x,y,oth) {
            var data ;
            if(oth == "NULL"){
                data = x+","+y;
                $("#addTbmCoord").val(data);
            }
        }

        /*初始化线路*/
        function initLine() {
            var pointsPart = "NULL";
            pointsPart = $("#hiddenPoints").val();
            if(pointsPart != "NULL"){
                var items = analysisPoints(pointsPart);
                var pcolor = $("#hiddenCircuitColor").val();
                draw(items,"init",pcolor,3);
            }

        }

        /*初始化工点段*/
        function initWorkSite() {
            var coordPart = "NULL";
            coordPart = $("#hiddenCoord").val();
            if(coordPart != "NULL"){
                var items = analysisPoints(coordPart);
                var wcolor = $("#hiddenWorksiteColor").val();
                draw(items,"init",wcolor,8);
            }

        }

        /*监听重置按钮*/
        $(".restPoints").on('click',function (e) {
            clearTag()
        });

        /*清除标记点*/
        function clearTag() {
            map.remove(marker);
            marker = "NULL";
//            $("#addTbmCoord").val('');
        }
        /*绘制*/
        function draw(points,order,color,lineWidth) {
            if(lineWidth == "NULL"){
                lineWidth = 3;
            }
            var polyline = new AMap.Polyline({
                path: points,          //设置线覆盖物路径
                strokeColor: color, //线颜色
                strokeOpacity: 1,       //线透明度
                strokeWeight: lineWidth,        //线宽
                strokeStyle: "solid",   //线样式
                strokeDasharray: [10, 5] //补充线样式
            });
            polyline.setMap(map);
        }
        /*绘制tag*/
        function creatMaker(x,y) {
            marker = new AMap.Marker({
                /*icon: new AMap.Icon({
                    size: new AMap.Size(40, 50),  //图标大小
                    image: "${CPATH}/images/tbm/tbm2.png",
                    imageOffset: new AMap.Pixel(0, -60)
                }),*/
                icon: "${CPATH}/images/tbm/tbm02.png",
//                offset: new AMap.Pixel(-8,0),
                draggable:true,
                cursor: 'move',
//                raiseOnDrag: true,
                position: [x, y]


//                map: map,
//                position: [x, y],
//                icon: new AMap.Icon({
//                    size: new AMap.Size(40, 50),  //图标大小
//                    image: "http://webapi.amap.com/theme/v1.3/images/newpc/way_btn2.png",
//                    imageOffset: new AMap.Pixel(-20, -40)
//                })
            });
            marker.on("dragend", function (e) {
                var x = e.lnglat.getLng();
                var y = e.lnglat.getLat();
                setAddPoints(x,y,"NULL");
            });
            marker.setMap(map);
            setAddPoints(x,y,"NULL");
        }
    });
</script>
</@layout>
