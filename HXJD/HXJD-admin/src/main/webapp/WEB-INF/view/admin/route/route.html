<#include "../../_include/_layout.inc.tag"/>
<@layout active_id="dashboard">
<link href="${CPATH}/plus/zTree/css/metroStyle/metroStyle.min.css" rel="stylesheet" type="text/css">
<input type="hidden" id="hiddenValue" value="0">
<div class="menuPage">
    <div class="layui-sidev" id="leftMenuPage">
        线路管理
        <hr>
        <ul id="treeDemo" class="ztree"></ul>
    </div>
    <div class="layui-body">
        盾构机信息
        <hr>
        <blockquote class="layui-elem-quote tableTool">
            <div class="layui-btn-group" id="btn_group">
                <button class="layui-btn layui-btn-sm" data-type="add"><i class="icon iconfont icon-xinzeng"></i><cite>新增</button>
                <button class="layui-btn layui-btn-sm" data-type="edit"><i class="icon iconfont icon-bianji"></i><cite>编辑</button>
                <button class="layui-btn layui-btn-sm" data-type="sel"><i class="icon iconfont icon-xiangqing"></i><cite>查看</button>
                <button class="layui-btn layui-btn-sm layui-btn-danger" data-type="del"><i class="icon iconfont icon-shanchu"></i><cite>删除</button>
            </div>
        </blockquote>
        <table id="positionData" lay-filter="positionData"></table>
    </div>
</div>
<script src="${CPATH}/plus/zTree/js/jquery.ztree.all.min.js" type="text/javascript"></script>
<script>
    layui.use( ['table','common'], function(){
        var $ = layui.$,
            table = layui.table,
            common = layui.common;
        $(function(){
            $("#leftMenuPage").height($("#zero_body",window.parent.document).height()-45);
            $(window).on('resize', function() {
                $("#leftMenuPage").height($("#zero_body",window.parent.document).height()-45);
            });
            // zTree 的参数配置，深入使用请参考 API 文档（setting 配置详解）
            var setting = {
                isSimpleData : true,              //数据是否采用简单 Array 格式，默认false
                treeNodeKey : "id",               //在isSimpleData格式下，当前节点id属性
                showLine : true,                  //是否显示节点间的连线
                view: {
                    addHoverDom: addHoverDom,
                    removeHoverDom: removeHoverDom,
                    selectedMulti: false
                },
                edit: {
                    enable: true,
                    editNameSelectAll: true,
                    showRemoveBtn: showRemoveBtn,
                    showRenameBtn: showRenameBtn,
                    removeTitle: "删除节点",
                    renameTitle: "编辑节点"
                },
                data: {
                    simpleData: {
                        enable: true,
                        idKey: "id",
                        pIdKey: "pId"
                    }
                },
                callback: {
                    beforeClick: beforeClick,
                    beforeDrag: beforeDrag,
                    beforeEditName: beforeEditName,
                    beforeRemove: beforeRemove,
                    beforeRename: beforeRename,
                    onRemove: onRemove,
                    onRename: onRename,
                    onClick: zTreeOnClick
                }
            };

            var log, className = "dark";
            function beforeClick(treeId, treeNode) {
                var check = (treeNode && !treeNode.isParent);
                /*if(treeNode.id!=0){
                 if (!check) top.parent.MSG(2, "末尾节点才拥有功能按钮");
                 return check;
                 }*/

            }
            function showRemoveBtn(treeId, treeNode) {
                if(treeNode.id==0){
                    return false;
                }else{
                    return true;
                }
            }
            function showRenameBtn(treeId, treeNode) {
                if(treeNode.id==0){
                    return false;
                }else{
                    return true;
                }
            }

            function beforeDrag(treeId, treeNodes) {
                return false;
            }
            function beforeEditName(treeId, treeNode) {
                treeNode_=treeNode;
                treeType=2;
                if(treeNode_.level == 1){
                    common.tableOpenLayer('线路修改','icon-xinzeng',bpath+'/admin/route/editCicuit?id='+treeNode.id);
                }
                if(treeNode_.level == 2){
                    common.tableOpenLayer('工点修改','icon-xinzeng',bpath+'/admin/route/editWorksite?id='+treeNode.id);
                }
                return false;
            }
            function zTreeOnClick(event, treeId, treeNode) {
                $("#hiddenValue").attr("value", treeNode.id);
                var zlevel = treeNode.level;
                tempData=null;
                where= treeNode.id;
                t.reload({
                    page: {
                        curr: 1 //重新从第 1 页开始
                    },
                    where: { //设定异步数据接口的额外参数，任意设
                        type:zlevel,
                        menuId: treeNode.id
                    }
                })
            };
            function beforeRemove(treeId, treeNode) {
                className = (className === "dark" ? "":"dark");
                var zTree = $.fn.zTree.getZTreeObj("treeDemo");
                zTree.selectNode(treeNode);
                return confirm("确认删除 节点 -- " + treeNode.name + " 吗？");
            }
            function onRemove(e, treeId, treeNode) {
                var level = treeNode.level;
                $.ajax({
                    url : bpath + "/admin/route/delTreeNode?id="+treeNode.id+"&level="+level,
                    type : 'get',
                    dataType : 'json',
                    success : function(json) {
                        if(json.errorCode==0){
                            top.parent.MSG(4, json.message);
                            parent.layer.close(index); //再执行关闭
                        }else{
                            top.parent.MSG(3, json.message);
                        }
                        reloadTreeData();
                    },

                });
            }
            function beforeRename(treeId, treeNode, newName, isCancel) {
                className = (className === "dark" ? "":"dark");
                if (newName.length == 0) {
                    setTimeout(function() {
                        var zTree = $.fn.zTree.getZTreeObj("treeDemo");
                        zTree.cancelEditName();
//                        alert("节点名称不能为空.");
                    }, 0);
                    return false;
                }
                return true;
            }
            function onRename(e, treeId, treeNode, isCancel) {
                $.ajax({
                    url : bpath + "/admin/department/editTree?id="+treeNode.id+"&name="+treeNode.name,
                    type : 'get',
                    dataType : 'json',
                    success : function(data) {
// 					console.log(data);
                    }
                });
            }

            var newCount = 1;
            function addHoverDom(treeId, treeNode) {
                console.log("treeNode:");
                console.log(treeNode);
                var sObj = $("#" + treeNode.tId + "_span");
                if (treeNode.editNameFlag || $("#addBtn_"+treeNode.tId).length>0) return;
                if(treeNode.level<2) {
                    var addStr = "<span class='button add' id='addBtn_" + treeNode.tId + "' title='新增' onfocus='this.blur();'></span>";
                    sObj.after(addStr);
                }
                var btn = $("#addBtn_"+treeNode.tId);
                if (btn) btn.bind("click", function(){
                    treeNode_=treeNode;
                    treeType=1;
                    if(treeNode.level == 0){
                        common.tableOpenLayer('新增线路','icon-xinzeng',bpath+'/admin/route/addCircuit?pId='+treeNode.id);
                    }
                    if(treeNode.level == 1){
                        common.tableOpenLayer('新增工点','icon-xinzeng',bpath+'/admin/route/addWorkSite?pId='+treeNode.id);
                    }
                    return false;
                });
            };
            function removeHoverDom(treeId, treeNode) {
                $("#addBtn_"+treeNode.tId).unbind().remove();
            };
            function reloadTreeData(){
                $.ajax({
                    url : bpath + "/admin/route/tree",
                    type : 'get',
                    dataType : 'json',
                    success : function(data) {
                        zTree = $.fn.zTree.init($("#treeDemo"), setting, data);
                        console.log("树形数据");
                        console.log(data);
                        zTree.expandAll(true);
                    }
                });
            }
            reloadTreeData();

        });
        //表格渲染
        t = table.render({
                id:'positionData'
                ,${tableBase}												//基础属性
            ,url:'${BPATH}/admin/route/tbmData'							//数据地址
            ,elem: '#positionData' 											//指定原始表格元素选择器（推荐id选择器）
            ,height: 'full-105' 											//容器高度，高度最大化减去差值
            ,cols: [[
            {${thBase},title:'ID',field:'id', width:80, sort: true},
        {${thBase},title:'盾构机名称',field:'name'},
        {${thBase},title:'盾构机编码',field:'code'},
        {${thBase},title:'上次维修时间',field:'repairtime'},
        {${thBase},title:'维修人',field:'repairman'},
        {${thBase},title:'下次维修时间',field:'cycle'}
        ]],
        done: function(res, curr, count){
            page = curr;
        }
    });
        table.on('tool(positionData)', function(obj){
            tempData=obj.data
        });

        active = {
            <!-- 新增操作 -->
            add:function(){
                common.tableOpenLayer('职位新增','icon-xinzeng',bpath+'/admin/route/addTbm?workSiteId='+$("#hiddenValue").val());
            },
            <!-- 修改操作 -->
            edit:function(){
                if(null==tempData){
                    top.parent.MSG(2, "请选择一条数据");
                    return false;
                }
                common.tableOpenLayer('职位编辑','icon-bianji',bpath+'/admin/route/tbmEdit?id='+tempData.id);
            },
            <!-- 查询操作 -->
            sel:function(){
                if(null==tempData){
                    top.parent.MSG(2, "请选择一条数据");
                    return false;
                }
                common.tableOpenLayer('盾构机详情','icon-xiangqing',bpath+'/admin/route/selTbm?id='+tempData.id);
            },
            <!-- 删除操作 -->
            del:function() {
                if (null == tempData) {
                    top.parent.MSG(2, "请选择一条数据");
                    return false;
                }
                common.zeroCmsConfirm('是否确认删除',bpath+'/admin/route/delTbm?id='+tempData.id);
            }

        };
        $('#btn_group .layui-btn').on('click',function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });

        $('.layui-inline .layui-btn').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    });
</script>
<script type="text/html" id="switchTpl">
    <input type="checkbox" name="state" disabled="" value="{{d.state}}" lay-skin="switch" lay-text="开放|关闭" lay-filter="" {{ d.state == 1 ? 'checked' : '' }}>
</script>
</@layout>