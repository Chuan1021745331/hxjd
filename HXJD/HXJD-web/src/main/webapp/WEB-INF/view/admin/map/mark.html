<style>
    .markGroup{
        margin-top: 2%;
        box-sizing: border-box;
    }

    .form-group input{
        width: 30%;
    }
    .IcoMark input{
        margin-left:6% ;
    }
    .IcoMark img {
        margin-left: 2%;
    }

</style>
<!-- top tiles -->
<div class="row">
    <div class="col-md-12 col-sm-12 col-xs-12">
        <div class="x_panel">
            <div class="x_title">
                <h2>
                    标注点设置<small></small><div id="returnmessage"></div>
                </h2>
                <div class="clearfix"></div>
                <div class="x_content">
                    <form id="form" action="${BPATH}/admin/mark/Save" class="form-horizontal form-label-left input_mask">
                        <div class="markGroup">
                            <div class="form-group" hidden >
                                <label class="control-label col-md-3 col-sm-3 col-xs-12"></label>
                                <div class="col-md-9 col-sm-9 col-xs-12">
                                    <input id="id"type="text" name="jMark.id">
                                </div>
                            </div>

                            <div class="form-group" style="margin-left:-25%; ">
                                <label class="control-label col-md-3 col-sm-3 col-xs-12"style="font-size: 15px;" >代号</label>
                                <input  id="code"name="jMark.code"  type="text"  class="form-control col-md-1 col-sm-1">
                                <label class="control-label col-md-1 col-sm-1 col-xs-12"style="font-size: 15px;">备注</label>
                                <input id="remark" name="jMark.remark" type="text"  class="form-control col-md-1 col-sm-1">
                            </div>

                            <div class="form-group" style="margin-left:-25%; ">
                                <label class="control-label col-md-3 col-sm-3 col-xs-12"style="font-size: 15px;" >经度</label>
                                <input id="Latitude" name="jMark.x" type="text"  class="form-control col-md-1 col-sm-1">
                                <label  class="control-label col-md-1 col-sm-1 col-xs-12"style="font-size: 15px;">纬度</label>
                                <input id="Longtude" name="jMark.y" type="text" class="form-control col-md-1 col-sm-1">
                            </div>

                            <div class="form-group" style="margin-left:-25%; ">
                                <label class="control-label col-md-3 col-sm-3 col-xs-12"style="font-size: 15px;" >图标</label>
                                <div class="IcoMark"style="margin-top:0.5%;">
                                    <input id="Ico1" name="jMark.icon" type="radio" value="1" style=" width:20px;height:20px"  >
                                    <img src="${CPATH}/img/markIco1.png" style="width:80px; height: 80px">
                                    <input id="Ico2" name="jMark.icon" type="radio"  value="2" style=" width:20px;height:20px" >
                                    <img src="${CPATH}/img/markIco2.png" style="width:80px; height: 80px">
                                    <input id="Ico3" name="jMark.icon" type="radio" value="3"  style="  width:20px;height:20px" >
                                    <img src="${CPATH}/img/markIco3.png" style="width:80px; height: 80px">
                                    <input id="Ico4" name="jMark.icon" type="radio" value="4" style="  width:20px;height:20px" >
                                    <img src="${CPATH}/img/markIco4.png" style="width:80px; height: 80px">
                                </div>
                            </div>
                            <div id="submit" class="btn btn-success" style="float:right">保存</div>
                        </div>
                    </form>
                    <div class="x_title"></div>
                    <div id="mapMark" class="map"></div>
                </div>
            </div>
        </div>
    </div>


</div>
</div>

<script>
    $(function() {
        ajaxModelForm("form");
        $submit = $("#submit");

        $submit.on("click", function ()
        {
            $("#form").submit();
            showAtRight('/admin/mark');
        });
    });
    init();
    var map, fs=new Array() ,vL, delFs=new Array();
    var $submit;
    var markerOld = ${mark};

    function init() {
        map = new ol.Map({
            target: 'mapMark',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM(),


                })
            ],
            view: new ol.View({
                center: ol.proj.transform([37.41, 8.82], 'EPSG:4326', 'EPSG:3857'),
                zoom: 4
            }),
            controls: ol.control.defaults().extend(
                [new ol.control.ScaleLine()]),
            logo: false
        });


        //     	坐标拾取
        map.on('click', function(e)
        {

            var pixel = map.getEventPixel(e.originalEvent);
            var feature = map.forEachFeatureAtPixel(pixel, function(feature) {
                return feature;
            });
            // 判断当前单击处是否有要素，捕获到要素时弹出popup
            var coordinate = e.coordinate;
            if (feature !== undefined)
            {

                $.ajax(
                    {
                        url : bpath + "/admin/mark/edit?id="+feature.getId(),
                        type : 'get',
                        dataType : 'json',
                        success : function(data) {
                            $("#id").val(data.id);
                            $("#remark").val(data.remark);
                            $("#code").val(data.code);
                            $("#Latitude").val(data.x);
                            $("#Longtude").val(data.y)
                        }
                    });
                removeAllOverlay(map);
                var popup_element = document.createElement('div');
                popup_element.className = 'ol-popup';
                var closer = document.createElement('a');
                closer.href = '#';
                closer.className = 'fa ol-popup-closer';
                var title = document.createElement('div');
                title.className = 'title';
                var contentX = document.createElement('div');
                contentX.className = 'popup-content'
                var contentY = document.createElement('div');
                contentY.className = 'popup-content'
                var button = document.createElement('button')
                $(popup_element).append(closer);
                $(popup_element).append(title);
                $(popup_element).append(contentX);
                $(popup_element).append(contentY);
                $(popup_element).append(button);
                var info_popup = new ol.Overlay(({
                    element : popup_element,
                    autoPan : true,
                    autoPanAnimation : {
                        duration : 250
                        // 当Popup超出地图边界时，地图移动的速度
                    }
                }));
                info_popup.set("id", feature.getId() + "o", true);
                map.addOverlay(info_popup);
                $(closer).on('click', function(event) {
                    event.preventDefault();
                    info_popup.setPosition(undefined);
                });

                // 点击关闭的按钮

                var id = feature.getId();
                var x = feature.get("x");
                var y = feature.get("y");
                title.innerHTML= '<div><div>标注点ID:&nbsp;' + id +'</div></div>'
                contentX.innerHTML='<div><div>标注点X坐标:&nbsp;' + x +'</div></div>'
                contentY.innerHTML='<div><div>标注点y坐标:&nbsp;' + y +'</div></div>'
                button.innerHTML='删除标注点'
                info_popup.setPosition(coordinate);
                $(button).on('click',function() {
                    $.ajax({
                        url: bpath + "/admin/mark/del?id=" + feature.getId(),
                        type: 'get',
                        dataType: 'json',
                        success : function() {
                            for (var i = 0; i < fs.length; i++) {
                                var o = fs[i];
                                if (o.getId() == id) {
                                    var v = vL.getSource();
                                    v.removeFeature(v.getFeatureById(id));
                                    removeAllOverlay(map);
                                    $("#id").val("")
                                    $("#remark").val("")
                                    $("#code").val("");
                                    $("#Latitude").val("");
                                    $("#Longtude").val("");
                                    delFs.push(id);
                                }
                            }
                            showAtRight('/admin/mark');
                            PN("success", '删除图元标注点成功！', "成功删除");

                            fs=new Array();
                        }
                    })
                })

            }
            //
            else{
                var icon = $("input[type='radio']:checked").val();
                if(icon==undefined){
                    PN("error", '没有选择图标！', "请点击图标选项");
                    return;
                }
                var coord = e.coordinate;
                var degrees = ol.proj.transform(coord, 'EPSG:3857', 'EPSG:4326');
                var hdms = ol.coordinate.toStringXY(degrees, 4);
                var h = hdms.split(",");
                var newId = 1;

                delMarker();
                removeAllOverlay(map);
                createMarker(newId, icon,parseFloat(h[0]), parseFloat(h[1]));
                for (var i = 0; i < markerOld.length; i++) {
                    var m = markerOld[i];
                    if(delFs.indexOf(m.id)){
                        createMarker(m.id, m.icon, parseFloat(m.x), parseFloat(m.y));

                    }else{
                    }
                }
                $("#id").val("")
                $("#remark").val("")
                $("#code").val("");
                //更新点击点坐标
                $("#Latitude").val(h[0]);
                $("#Longtude").val(h[1]);

                addMarkerS();
            }

        });


    };
    //


    function mark() {
        var markers =${mark};
        for(var i = 0; i < markers.length; i++){
            var m = markers[i];
            createMarker(m.id, m.icon, parseFloat(m.x) ,parseFloat(m.y));

        }
        addMarkerS();
    }
    //获取图片
    var styles = [
        new ol.style.Style({
            image: new ol.style.Icon({
                src: cpath + "/img/mark1.png"
            })
        }),
        new ol.style.Style({
            image: new ol.style.Icon({
                src: cpath + "/img/mark2.png"
            })
        }),
        new ol.style.Style({
            image: new ol.style.Icon({
                src: cpath + "/img/mark3.png"
            })
        }),
        new ol.style.Style({
            image: new ol.style.Icon({
                src: cpath + "/img/mark4.png"
            })
        })
    ];

    function createMarker(id,icon,x,y) {
        console.log(id +"~" + icon +"~" + x + "~" + y);
        var marker = new ol.Feature({
            geometry: new ol.geom.Point(ol.proj.fromLonLat([x, y]))
        });
        if (icon == 1) {
            marker.setStyle(styles[0]);
        } else if(icon == 2){
            marker.setStyle(styles[1]);
        }else if(icon ==3) {
            marker.setStyle(styles[2]);
        } else{
            marker.setStyle(styles[3]);
        }
        marker.setId(id);
        marker.set("x",x);
        marker.set("y",y);
        fs.push(marker);
//        console.log(fs.length);
    }
    //新增标注 多次创建，只需调用一次该方法即可添加marker
    function addMarkerS() {
        vL = new ol.layer.Vector({
            source : vectorSource = new ol.source.Vector({
                features : fs
            })
        });
        map.addLayer(vL);
    }

    //移除弹框
    function removeAllOverlay(map) {
        var os = map.getOverlays().getArray();
        for (var i = 0; i < os.length; i++) {
            var o = os[i];
            console.log(o.get("id"));
            if (o.get("id") != undefined) {
                map.removeOverlay(o);
            }
        }
    }
    /* 删除所有标注 */
    function delMarker() {
        for(var i=0;i<fs.length;i++){
            vL.getSource().removeFeature(fs[i]);

        }
        map.removeLayer(vL);
        fs=new Array();
    }
    mark();
</script>
