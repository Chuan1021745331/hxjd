<!DOCTYPE html>
<html lang="en">
<meta http-equiv="Content-Type"
      content="multipart/form-data; charset=utf-8">
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
<head>

    <title>盾构机web端 --v1.0</title>
    <link rel="stylesheet" type="text/css" media="all" href="${CPATH}/css/smart/msmart.css">
    <link rel="stylesheet" type="text/css" media="all" href="${CPATH}/css/smart/smart.css">
    <link rel="stylesheet" type="text/css" media="all" href="${CPATH}/frame/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="${CPATH}/css/font/iconfont.css" media="all">
    <script type="text/javascript" src="${CPATH}/ckplayer/ckplayer.js"></script>
    <!--<script type="text/javascript" src="${CPATH}/js/route/heatbeats.js"></script>-->

    <script type="text/javascript">
        ctx = '${CPATH}';
        cty = '127.0.0.1:8088/${BPATH}';
        bpath='${BPATH}';
    </script>
<body>
<input id="ckpalyer_swf" type="hidden" value="${CPATH}/ckplayer/ckplayer.swf"/>
<div id="root_div">
    <div id="root_div_2" class="ms-width-100-per ms-height-100-per  ms-layout-center-horizontal ms-scrollbar-black" style="overflow: scroll">
        <div id="a1_div" class="ms-width-85-per ms-height-100-per">
            <div id="a1" class="cameraDiv ms-width-100-per ms-height-100-per"></div>
        </div>
        <div id="cameras" class="ms-width-15-per ms-height-40-per ms-margin-left-1rem ms-layout-wrap-vertical z-depth-2">
            <#if cameras??>
                <#list cameras as item>
                    <button class="<#if item_index==0>layui-btn-warm</#if> layui-btn layui-btn-primary cameraButton" cdata = "${item.rtsp!}" >摄像头${item_index+1}（${item.name!}）</button>
                </#list>
                <#else><h2>暂无摄像头</h2>
            </#if>
        </div>



        <!--<div id="cameras" class="ms-width-100-per ms-height-100-per  ms-layout-center-wrap-horizontal ">
            <#if cameras??>
                <#list cameras as item>
                    <div id="a${item.id!}" class="cameraDiv c${item_index} ms-width-45-per ms-height-45-per"></div>
                </#list>
                <#else><h2>暂无摄像头</h2>
            </#if>
        </div>-->
    </div>
</div>
</body>
<script type="text/javascript" src="${CPATH}/plus/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="${CPATH}/plus/toastr/toastr.min.js"></script>
<script type="text/javascript" src="${CPATH}/frame/layui/layui.js"></script>
<script type="text/javascript" src="${CPATH}/js/index.js"></script>
<script type="text/javascript" src="${CPATH}/plus/echarts.min.js"></script>
<script type="text/javascript" src="${CPATH}/plus/shine.js"></script>
<script type="text/javascript" src="${CPATH}/js/route/globalvariable.js"></script>

<script type="text/javascript">
    /**
     * Created by hxjd on 2018/1/26.
     */
    layui.use(['form','layer','element'], function(){
        var element = layui.element;
        var layer = layui.layer;
        var tbmid = ${tid};
//        var hs = ${hs};
        var device = layui.device();
//        if(hs == 0){
//            layer.open({
//                type: 2,
//                resize: false,
//                content: "该盾构机没有添加摄像头！"});
//        }

        if(device.android || device.ios){

            var height = $(window).height()-112;
            $("#root_div_2").removeClass("ms-layout-center-horizontal");
            $("#a1_div").removeClass("ms-width-85-per");
            $("#a1_div").removeClass("ms-height-100-per");
            $("#a1_div").addClass("ms-width-100-per");
            $("#a1_div").addClass("ms-height-40-per");
            $("#cameras").removeClass("ms-width-15-per");
            $("#cameras").removeClass("ms-margin-left-1rem");
            $("#cameras").removeClass("ms-layout-wrap-vertical");
            $("#cameras").removeClass("z-depth-2");
            $("#cameras").removeClass("ms-height-40-per");

            $("#cameras").addClass("ms-height-40-per");
//            $("#cameras").addClass("debug");
            $("#cameras").addClass("ms-width-100-per");
            $("#cameras").addClass("ms-margin-top-1rem");
            $("#cameras").addClass("ms-layout-center-wrap-horizontal");



            /*$("#cameras").removeClass("ms-layout-center-wrap-horizontal");
            $("#cameras").removeClass("ms-height-100-per");
            $("#root_div_2").removeClass("black");
//            $("#cameras").addClass("ms-margin-top-8rem");
            $("#cameras").css("margin-top",336);

//            $("#cameras").addClass("ms-layout-nowrap-vertical");
            $(".cameraDiv").removeClass("ms-width-45-per");
            $(".cameraDiv").removeClass("ms-height-45-per");
            $(".cameraDiv").css("height",height/2);
            $(".cameraDiv").addClass("ms-margin-top-2rem");
            $(".cameraDiv").addClass("ms-width-100-per");*/
//            $(".c0").addClass("ms-margin-top-4rem");
        }

        if(oldTbmid == "NULL"){
            oldTbmid = 0000;
        }



        initSizeHeight($("#root_div"));
        //监听折叠
        element.on('test', function(data){
            layer.msg('展开状态：'+ data.show);
        });
        var pdata = $(".layui-btn-warm").attr("cdata");
        playCamera(pdata,1);
        /*var cameras = '${camerasjson}';
        var camerasJson = $.parseJSON(cameras);
        for(var i = 0;i<camerasJson.length;i++){
            var rtmp = camerasJson[i].rtsp;
            var rtmpName = camerasJson[i].name;
            var num = camerasJson[i].id;
            playCamera(rtmp,1);
        }*/

        /*摄像头按钮事件*/
        $(".cameraButton").on("click",function () {
            var rtmp = $(this).attr("cdata");
            $(this).siblings(".cameraButton").removeClass("layui-btn-warm");
            $(this).addClass("layui-btn-warm");
            playCamera(rtmp,1);
        })

        /**
         * 初始化页面大小
         * @param $obj
         * @param isIndex
         */
        function initSizeHeight($obj, isIndex)
        {
            // var width = document.documentElement.clientWidth;
            var height = $(window).height();
            if(isIndex)
            {
                $obj.css({ height: height - 60});//112是控制栏
            }
            else
            {
                $obj.css({height:height});
            }
        }
        /*ckplayer播放*/
        function playCamera(rtmp,num) {
            var width = $("#a"+num).width()*1;
            var height = $("#a"+num).height()*0.95;
//            var width = $("#a"+num).width()*0.8;
//            var height = $("#a"+num).height()*0.95;
            /*alert(width)*/
            var flashvars={
                f:rtmp,//'rtmp://120.78.49.241:1935/live/test1'
                c:0,
                b:1,
                i:'http://www.ckplayer.com/static/images/cqdw.jpg'
            };
            var video=[rtmp+'->video/mp4'];
//    var swf = ;
            CKobject.embed($('#ckpalyer_swf').val(),'a'+num,'ckplayer_a'+num,width,height,false,flashvars,video)
            function closelights(){//关灯
//        alert(' 本演示不支持开关灯');
            }
            function openlights(){//开灯
//        alert(' 本演示不支持开关灯');
            }
        }
        /*WebSocket*/
        var webSocket = null;
// var webSocketUrl = "ws://localhost:10105/videoPlayCheck";
        var webSocketUrl = "ws://192.168.0.192:18080/HeartBeat.ws";
        initWebSocket(webSocketUrl);
        function initWebSocket(url) {
            if ('WebSocket' in window) {
                webSocket = new WebSocket(url);
            } else {
                alert('对不起，您的浏览器不支持websocket，请更换浏览器')
            }

            //Error callback
            webSocket.onerror = function () {
                layer.open({
                    title: 'webSocket错误'
                    ,content: 'error'
                });
            };

            //socket opened callback
            webSocket.onopen = function (event) {
                initSend();
            };

            webSocket.onmessage = function (event) {
                dataHandler(event.data);
            };

            webSocket.onclose = function () {
                layer.open({
                    title: 'webSocket关闭'
                    ,content: 'onclose'
                });
            };

            //when browser window closed, close the socket, to prevent server exception
            window.onbeforeunload = function () {
                webSocket.close();
                // alert("onbeforeunload")
            }
        }

        function sendActived()
        {
            webSocket.send("#hxjd#2#1")

        }
        function sendActived1()
        {
            webSocket.send("#hxjd#1#2")

        }
        function initSend() {
            console.log("initSend")
            webSocket.send("#hxjd#"+oldTbmid+"#"+tbmid);
            oldTbmid = tbmid;
        }

        function dataHandler(data)
        {
            console.log("收到服务器反馈：" + data);
        }

    });
</script>
</html>